<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RentalFlow AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        /* Hide body until auth check is complete to prevent flicker */
        body.loading { visibility: hidden; }
    </style>
</head>
<body class="bg-gray-100 loading">

    <div id="app-container" class="flex h-screen bg-gray-200" style="display: none;">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-gray-900 text-white p-6 space-y-6 transform -translate-x-full md:relative md:translate-x-0 transition z-30">
            <a href="/dashboard" class="flex items-center space-x-3">
                <img id="company-logo-sidebar" src="https://placehold.co/40x40/ffffff/1a202c?text=RF" alt="Logo" class="w-10 h-10 rounded-full">
                <span id="company-name-sidebar" class="text-2xl font-bold">RentalFlow</span>
            </a>
            <nav class="space-y-2">
                <a href="/dashboard" class="flex items-center py-2.5 px-4 rounded-lg bg-gray-700 text-white"><i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span></a>
                <a href="/bookings" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-calendar-alt w-6"></i><span class="ml-3">Bookings</span></a>
                <a href="/customers" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-users w-6"></i><span class="ml-3">Customers</span></a>
                <a href="/fleet" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-car w-6"></i><span class="ml-3">Vehicle Fleet</span></a>
                <a href="/invoices" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-file-alt w-6"></i><span class="ml-3">Invoices</span></a>
                <a href="/settings" class="flex items-center py-2.5 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-cog w-6"></i><span class="ml-3">Settings</span></a>
            </nav>
            <div class="absolute bottom-6 left-6 right-6">
                <button id="sign-out-button" class="w-full flex items-center justify-center bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-sign-out-alt w-6"></i><span class="ml-3">Sign Out</span>
                </button>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-6 bg-white border-b">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i class="fas fa-bars text-2xl"></i></button>
                    <h1 class="text-2xl font-semibold text-gray-800 ml-4 md:ml-0">Dashboard</h1>
                </div>
                <div id="user-info" class="text-right">
                    <p class="font-semibold text-gray-800" id="user-email"></p>
                    <p class="text-sm text-gray-500">Company Admin</p>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">Total Bookings</p><p id="total-bookings" class="text-3xl font-bold">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">Vehicles Available</p><p id="vehicles-available" class="text-3xl font-bold">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">Total Customers</p><p id="total-customers" class="text-3xl font-bold">0</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">Needs Maintenance</p><p id="needs-maintenance" class="text-3xl font-bold">0</p></div>
                </div>
                <!-- Recent Bookings Table -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Recent Bookings</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="bg-gray-50 border-b"><th class="p-4">Customer</th><th class="p-4">Vehicle</th><th class="p-4">Dates</th><th class="p-4">Status</th></tr></thead>
                            <tbody id="recent-bookings-table"><tr><td colspan="4" class="text-center p-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="loader" class="flex items-center justify-center h-screen"><i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i><p class="ml-4 text-xl">Authenticating...</p></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/js/firebase-init.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('app-container');
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in.
                    loader.style.display = 'none';
                    appContainer.style.display = 'flex';
                    document.body.classList.remove('loading');
                    initializeApp(user);
                } else {
                    // No user is signed in. Redirect to login page.
                    window.location.href = '/';
                }
            });

            function initializeApp(user) {
                const db = firebase.firestore();
                const companyId = user.uid; // For owners, the company ID is their user ID.

                // --- UI Elements ---
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('sign-out-button').addEventListener('click', () => {
                    auth.signOut().then(() => {
                        window.location.href = '/';
                    });
                });
                document.getElementById('menu-button').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('-translate-x-full');
                });

                // --- Fetch Company-Specific Data ---
                
                // Fetch Company Profile for branding
                const companyRef = db.collection('companies').doc(companyId);
                companyRef.get().then(doc => {
                    if (doc.exists) {
                        const companyData = doc.data();
                        document.getElementById('company-name-sidebar').textContent = companyData.companyName;
                        if (companyData.logoUrl) {
                            document.getElementById('company-logo-sidebar').src = companyData.logoUrl;
                        }
                    }
                });

                // Fetch dashboard stats from subcollections
                const bookingsRef = companyRef.collection('bookings');
                const vehiclesRef = companyRef.collection('vehicles');
                const customersRef = companyRef.collection('customers');

                bookingsRef.get().then(snap => { document.getElementById('total-bookings').textContent = snap.size; });
                customersRef.get().then(snap => { document.getElementById('total-customers').textContent = snap.size; });
                vehiclesRef.onSnapshot(snap => {
                    let available = 0;
                    let maintenance = 0;
                    snap.forEach(doc => {
                        const vehicle = doc.data();
                        if (vehicle.status === 'available') available++;
                        if (vehicle.status === 'maintenance') maintenance++;
                    });
                    document.getElementById('vehicles-available').textContent = available;
                    document.getElementById('needs-maintenance').textContent = maintenance;
                });

                // Fetch recent bookings
                const bookingsTable = document.getElementById('recent-bookings-table');
                bookingsRef.orderBy('createdAt', 'desc').limit(5).onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        bookingsTable.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">No recent bookings.</td></tr>`;
                        return;
                    }
                    bookingsTable.innerHTML = snapshot.docs.map(doc => {
                        const b = doc.data();
                        return `<tr class="border-b hover:bg-gray-50">
                                    <td class="p-4">${b.customerName}</td>
                                    <td class="p-4">${b.vehicleName}</td>
                                    <td class="p-4">${new Date(b.startDate.seconds * 1000).toLocaleDateString()}</td>
                                    <td class="p-4">${b.status}</td>
                                </tr>`;
                    }).join('');
                });
            }
        });
    </script>
</body>
</html>
